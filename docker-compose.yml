version: '1.0'

services: 
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.16.1
    ports: 
      - 9200:9200
    environment:
      - xpack.monitoring.enabled=true
      - xpack.watcher.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - discovery.type=single-node
    networks:
      - elastic

  kibana:
    image: docker.elastic.co/kibana/kibana:7.16.1
    ports: 
      - 5601:5601
    depends_on:
      - elasticsearch
    environment:
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    networks:
      - elastic

  log-service:
    image: log-service
    ports: 
      - 8084:80
    networks:
      - elastic
    depends_on: 
      - elasticsearch
      - kibana

  sql-server: 
    image: mcr.microsoft.com/azure-sql-edge:latest
    cap_add: [ 'SYS_PTRACE' ]
    environment:
      - "ACCEPT_EULA=1"
      - "MSSQL_SA_PASSWORD=Str#ng_Passw#rd"
    ports: 
      - 1433:1433
    networks: 
      - shop-env

  snowflake-factory:
    image: snowflake-factory
    ports: 
      - 8081:80
    networks: 
      - snowflake-id  
    expose: 
      - "80"

  shop-backend-api:
    image: shop-backend-api
    ports: 
      - 8082:80
    networks: 
      - shop-env  
      - snowflake-id
      - kibana
    expose: 
      - "80"
    depends_on:
      - sql-server
      - snowflake-factory

  shop-frontend:
    image: shop-frontend
    ports: 
      - 8083:80
    networks: 
      - shop-env
    depends_on:
      - shop-backend-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development

networks:
  shop-env:
  snowflake-id:
  kibana:
  elastic:
    driver: bridge
